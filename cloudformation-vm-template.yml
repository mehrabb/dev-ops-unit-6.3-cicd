AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Provisions three Amazon Linux 2 EC2 instances (Prod, Staging, Dev) 
  and bootstraps them with Python, pip, and a virtual environment for Flask/Gunicorn.

# --- PARAMETERS ---
Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair to enable SSH access (required for login).
  
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: Latest Amazon Linux 2 AMI ID from SSM Parameter Store

# --- RESOURCES ---
Resources:

  # 1. Security Group to Allow Access
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH (22) and HTTP (80) access
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: CICD-App-SecurityGroup

  # 2. Production EC2 Instance
  ProdInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          USER_NAME=ec2-user
          
          # Update and install necessary packages (Amazon Linux uses yum)
          sudo yum update -y
          sudo yum install -y python3 python3-pip git
          sudo yum install -y python3-devel
          
          # Create the application directory and ensure correct permissions
          sudo mkdir -p /var/www/app
          sudo chown -R ${!USER_NAME}:${!USER_NAME} /var/www
          
          # Switch user and set up the virtual environment and dependencies
          sudo -H -u ${!USER_NAME} bash -c 'cd /var/www/app && /usr/bin/python3 -m venv venv && source venv/bin/activate && pip install flask gunicorn'
          echo 'VM setup complete!'
      Tags:
        - Key: Name
          Value: production-app-server

  # 3. Staging EC2 Instance
  StagingInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          USER_NAME=ec2-user
          
          # Update and install necessary packages (Amazon Linux uses yum)
          sudo yum update -y
          sudo yum install -y python3 python3-pip git
          sudo yum install -y python3-devel
          
          # Create the application directory and ensure correct permissions
          sudo mkdir -p /var/www/app
          sudo chown -R ${!USER_NAME}:${!USER_NAME} /var/www
          
          # Switch user and set up the virtual environment and dependencies
          sudo -H -u ${!USER_NAME} bash -c 'cd /var/www/app && /usr/bin/python3 -m venv venv && source venv/bin/activate && pip install flask gunicorn'
          echo 'VM setup complete!'
      Tags:
        - Key: Name
          Value: staging-app-server

  # 4. Development EC2 Instance
  DevInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          USER_NAME=ec2-user
          
          # Update and install necessary packages (Amazon Linux uses yum)
          sudo yum update -y
          sudo yum install -y python3 python3-pip git
          sudo yum install -y python3-devel
          
          # Create the application directory and ensure correct permissions
          sudo mkdir -p /var/www/app
          sudo chown -R ${!USER_NAME}:${!USER_NAME} /var/www
          
          # Switch user and set up the virtual environment and dependencies
          sudo -H -u ${!USER_NAME} bash -c 'cd /var/www/app && /usr/bin/python3 -m venv venv && source venv/bin/activate && pip install flask gunicorn'
          echo 'VM setup complete!'
      Tags:
        - Key: Name
          Value: development-app-server


# --- OUTPUTS ---
Outputs:
  ProdPublicIP:
    Description: Public IP of the Production Server
    Value: !GetAtt ProdInstance.PublicIp
  StagingPublicIP:
    Description: Public IP of the Staging Server
    Value: !GetAtt StagingInstance.PublicIp
  DevPublicIP:
    Description: Public IP of the Development Server
    Value: !GetAtt DevInstance.PublicIp